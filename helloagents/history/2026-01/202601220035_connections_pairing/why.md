# 变更提案: 连接（局域网设备配对与多端同步）

## 需求背景

当前 WinUI 客户端主要面向本机使用，后端 Bridge Server 默认仅允许回环访问。随着 Android 端接入，需要在局域网内让其他设备安全地连接到同一后端，从而同步查看与控制同一会话（会话列表、历史消息、流式输出、计划 plan 与部分设置）。

本提案新增“连接”功能入口与配对/设备管理能力，使用户可以通过二维码（或等价方式）完成首次配对，并在 WinUI 端可撤销任意设备的访问权限。

## 产品分析

### 目标用户与场景
- **用户群体:** 主要使用 Windows 进行 Codex 交互的开发者；希望在手机上同步查看/继续对话、或在离开电脑时查看流式输出进度。
- **使用场景:**
  - 电脑上运行 WinUI 客户端，手机扫码配对后在同一局域网内连接后端。
  - 手机端查看会话列表与历史消息，并可继续发送消息；电脑端与手机端都能实时看到流式输出与 plan 更新。
  - 电脑端在“连接”页管理已配对设备（查看在线状态、撤销某设备）。
- **核心痛点:** 多端接入缺少入口与安全的首次配对流程；远程访问默认关闭导致移动端无法使用；缺少可撤销的设备级授权。

### 价值主张与成功指标
- **价值主张:** 在保持“默认仅本机回环、安全优先”的前提下，提供易用且可治理的局域网多端同步。
- **成功指标:**
  - 首次配对平均耗时 < 60 秒（生成二维码 → 扫码 → PC 确认 → 连接成功）。
  - 设备授权可撤销且立即生效（撤销后远程请求/WS 连接返回 401/关闭）。
  - 多端实时同步：流式输出与 plan 更新在各端可见，延迟可接受（同局域网内）。

### 人文关怀
- **隐私与安全默认:** 远程访问默认关闭；启用与配对均需显式用户操作；设备令牌仅在首次配对时展示/下发一次。
- **可控性:** 支持逐台设备撤销与查看最近活动时间，降低“忘记关闭共享”带来的风险。

## 变更内容
1. WinUI：在侧边栏底部新增“连接”入口，提供“允许局域网连接/生成二维码/设备列表/撤销设备”等能力。
2. Bridge Server：新增设备配对与设备令牌机制（设备级 Bearer Token），并提供设备列表/撤销/配对请求等接口与事件。
3. Android：实现扫码配对、保存设备令牌、连接 HTTP/WS 并同步会话/消息/流式输出/plan。
4. 协议与文档：补充配对与设备管理相关 API/事件说明，明确远程鉴权与默认安全策略。

## 影响范围
- **模块:**
  - WinUI Client
  - Bridge Server
  - Protocol
  - Android Client
- **文件:**
  - `codex-bridge/MainWindow.xaml(.cs)`（新增导航项与路由）
  - `codex-bridge/Pages/*`（ConnectionsPage 新增）
  - `codex-bridge-server/Bridge/*`、`codex-bridge-server/Controllers/*`（配对/鉴权/设备存储）
  - `codex-bridge-android/app/src/main/*`（扫码与连接）
  - `helloagents/wiki/*`（API/协议/模块文档）
- **API:**
  - 新增连接/配对/设备管理相关 HTTP API
  - 新增（或扩展）WebSocket 事件/命令：设备配对请求、设备在线状态
- **数据:**
  - 新增“已配对设备”本地持久化（JSON 文件；后续可升级 SQLite）

## 核心场景

### 需求: 连接入口与设备管理
**模块:** WinUI Client, Bridge Server

#### 场景: 在 WinUI 侧边栏底部进入“连接”页
用户点击侧边栏底部“连接”，查看当前共享状态、可用局域网地址、二维码与已配对设备列表。
- 预期结果：展示后端状态（运行/未运行）、当前 WS/HTTP 地址、已配对设备（在线/离线、最后活跃），并可执行“开始配对/撤销设备”。

### 需求: 局域网配对（扫码 + PC 确认）
**模块:** WinUI Client, Bridge Server, Android Client, Protocol

#### 场景: Android 扫码发起配对，WinUI 确认后建立连接
WinUI 端开启“允许局域网连接”并生成二维码；Android 扫码后提交设备信息发起配对；WinUI 弹窗确认；确认后 Android 获得设备令牌并连接 HTTP/WS。
- 预期结果：未确认前 Android 无法访问会话/WS；确认后可拉取会话列表并接收流式输出；超时/拒绝时明确失败原因。

### 需求: 多端同步（会话/消息/流式输出/plan/设置）
**模块:** Bridge Server, Protocol, Android Client, WinUI Client

#### 场景: Android 查看会话与流式输出，并可发送消息
Android 端展示会话列表；进入会话后拉取历史消息；发送 `chat.send` 后接收 `chat.message.delta` 与 `run.plan.updated` 等事件并渲染。
- 预期结果：与 WinUI 端看到的内容一致；允许多端发送消息；plan 与流式输出在各端可同步更新。

### 需求: 撤销设备与安全策略
**模块:** WinUI Client, Bridge Server

#### 场景: WinUI 撤销某设备后立即失效
WinUI 在“连接”页撤销指定设备；服务端使该设备令牌失效并关闭其 WS 连接（如在线）。
- 预期结果：被撤销设备后续请求返回 401/WS 断开；WinUI 设备列表在线状态更新。

## 风险评估
- **风险:** 远程接口暴露带来未授权访问风险、局域网内恶意配对请求骚扰、令牌泄露导致越权访问。
- **缓解:**
  - 远程访问默认关闭；仅在用户显式启用后对外监听。
  - 首次配对需 PC 确认，并使用短时有效的配对邀请码（二维码包含）。
  - 设备令牌仅首次下发一次，服务端仅保存哈希；支持逐设备撤销。
  - 配对/鉴权加入限速与日志，避免暴力尝试与可疑行为不可追溯。
